import 'package:flutter/material.dart';
import 'package:flutter_tts/flutter_tts.dart';

class AdvancedStoryCompleteScreen extends StatefulWidget {
  const AdvancedStoryCompleteScreen({super.key});

  @override
  State<AdvancedStoryCompleteScreen> createState() => _AdvancedStoryCompleteScreenState();
}

class _AdvancedStoryCompleteScreenState extends State<AdvancedStoryCompleteScreen> {
  final FlutterTts flutterTts = FlutterTts();
  int score = 0;
  int attempts = 0;
  bool showScore = false;

  final List<Map<String, dynamic>> stories = [
    {
      "title": "ุฑุญูุฉ ุฅูู ุงูุญุฏููุฉ",
      "start": "ูู ููู ูุดูุณ ุฌูููุ ูุฑุฑุช ุณููู ุฃู ุชุฐูุจ ุฅูู ุงูุญุฏููุฉ ุงููุฑูุจุฉ ูู ููุฒููุง. ุฃุฎุฐุช ูุนูุง ููุณูุง ุตุบูุฑูุง ูุถุนุช ููู ุจุนุถ ุงูููุงูู ูุฒุฌุงุฌุฉ ูุงุก...",
      "hint": "ูุง ูู ุงูุชุตุฑู ุงูุตุญูุญ ูู ุงูุญุฏููุฉุ",
      "endings": [
        {"text": "ูุงูุชูุช ุจุตุฏููุงุชูุง ููุนุจุช ูุนูู ุจุฃูุงู ูุณุนุงุฏุฉ.", "isCorrect": true},
        {"text": "ููุทุนุช ุจุนุถ ุงูุฃุฒูุงุฑ ูุฃููุชูุง ุนูู ุงูุฃุฑุถ.", "isCorrect": false},
        {"text": "ูุฃููุช ูู ูุง ูุนูุง ูู ุทุนุงู ุซู ูุงูุช ุชุญุช ุดุฌุฑุฉ.", "isCorrect": false},
        {"text": "ูุณุฎุฑุช ูู ุงูุฃุทูุงู ุงูุขุฎุฑูู ูู ุงูุญุฏููุฉ.", "isCorrect": false},
      ]
    },
    {
      "title": "ุงููุงุฌุจ ุงููุฏุฑุณู",
      "start": "ุนุงุฏ ุฎุงูุฏ ูู ุงููุฏุฑุณุฉ ูุชุนุจูุงุ ููุงู ุนููู ุฅููุงุก ูุงุฌุจู ุงููุฏุฑุณู ูุจู ููุนุฏ ุงูููู. ุฌูุณ ุนูู ููุชุจู ููุชุญ ูุชุจู...",
      "hint": "ูุง ูู ุงูุณููู ุงููุณุคููุ",
      "endings": [
        {"text": "ูุจุฏุฃ ุจุชุฑููุฒ ูู ุญู ุงููุงุฌุจ ุญุชู ุงูุชูู ููู.", "isCorrect": true},
        {"text": "ูุฃุบูู ุงููุชุจ ูุฐูุจ ููุนุจ ุจุงููุฑุฉ.", "isCorrect": false},
        {"text": "ูุทูุจ ูู ุฃุฎูู ุฃู ูุญู ุงููุงุฌุจ ุจุฏูุงู ููู.", "isCorrect": false},
        {"text": "ููุชุจ ุฃู ุดูุก ุจุณุฑุนุฉ ููููู ุงููููุฉ.", "isCorrect": false},
      ]
    },
    {
      "title": "ุงููุชุงุจ ุงูุฌุฏูุฏ",
      "start": "ุญุตูุช ูููู ุนูู ูุชุงุจ ุฌุฏูุฏ ูุฏูุฉ ูู ุนูุชูุง. ูุงู ุงููุชุงุจ ูุญุชูู ุนูู ูุตุต ูุดููุฉ ูุฑุณููุงุช ุฌูููุฉ...",
      "hint": "ููู ูุชุนุงูู ูุน ุงููุชุจุ",
      "endings": [
        {"text": "ููุฑุฃุชู ุจุนูุงูุฉ ูุญุงูุธุช ุนููู ูุธูููุง ูุฑุชุจูุง.", "isCorrect": true},
        {"text": "ููุฒูุช ุจุนุถ ุงูุตูุญุงุช ูุชูุตููุง ุนูู ุญุงุฆุท ุบุฑูุชูุง.", "isCorrect": false},
        {"text": "ููุณูุชู ุชุญุช ุงูุณุฑูุฑ ููู ุชูุชุญู ุฃุจุฏูุง.", "isCorrect": false},
        {"text": "ูุฃุนุทุชู ูุตุฏููุชูุง ุฏูู ุฃู ุชูุฑุฃู.", "isCorrect": false},
      ]
    },
    {
      "title": "ุงูุญููุงู ุงูุฃููู",
      "start": "ูุฌุฏ ูุงุณุฑ ูุทุฉ ุตุบูุฑุฉ ุชููุก ุนูุฏ ุจุงุจ ุงูููุฒู. ุจุฏุช ุงููุทุฉ ุฌุงุฆุนุฉ ูุฎุงุฆูุฉ...",
      "hint": "ููู ูุชุนุงูู ูุน ุงูุญููุงูุงุชุ",
      "endings": [
        {"text": "ูุฃุญุถุฑ ููุง ุจุนุถ ุงูุทุนุงู ูุงููุงุก ุจูุทู.", "isCorrect": true},
        {"text": "ูุตุฑุฎ ุนูููุง ูุชุจุชุนุฏ ุนู ููุฒูู.", "isCorrect": false},
        {"text": "ูุฃูุณููุง ุจููุฉ ูุฃููุงูุง ุจุนูุฏูุง.", "isCorrect": false},
        {"text": "ูุชุฌุงูููุง ูุชุฑููุง ููุง ูู.", "isCorrect": false},
      ]
    },
  ];

  int currentStoryIndex = 0;
  String? feedback;
  bool showHint = false;

  List<Map<String, dynamic>> get currentEndings => stories[currentStoryIndex]["endings"];
  String get currentStart => stories[currentStoryIndex]["start"];
  String get currentTitle => stories[currentStoryIndex]["title"];
  String get currentHint => stories[currentStoryIndex]["hint"];

  @override
  void initState() {
    super.initState();
    flutterTts.setLanguage("ar-SA");
    flutterTts.setSpeechRate(0.45);
    _speakText(currentTitle + ". " + currentStart);
    currentEndings.shuffle();
  }

  Future<void> _speakText(String text) async {
    await flutterTts.stop();
    await flutterTts.speak(text);
  }

  void _handleChoice(Map<String, dynamic> ending) {
    setState(() {
      feedback = ending["isCorrect"] ? "ุฃุญุณูุช! โ" : "ุญุงูู ูุฑุฉ ุฃุฎุฑู โ";
      if (ending["isCorrect"]) {
        score++;
      }
      attempts++;
      showHint = false;
    });
    _speakText(ending["isCorrect"] 
      ? "ุฅุฌุงุจุฉ ุตุญูุญุฉ! ${ending["text"]}" 
      : "ููุฃุณู ูุฐู ููุณุช ุงูุฅุฌุงุจุฉ ุงููุซุงููุฉ. ${ending["text"]}");
  }

  void _nextStory() {
    setState(() {
      if (currentStoryIndex < stories.length - 1) {
        currentStoryIndex++;
      } else {
        showScore = true;
      }
      feedback = null;
      currentEndings.shuffle();
      showHint = false;
    });
    if (!showScore) {
      _speakText(currentTitle + ". " + currentStart);
    }
  }

  void _resetGame() {
    setState(() {
      currentStoryIndex = 0;
      score = 0;
      attempts = 0;
      feedback = null;
      showScore = false;
      currentEndings.shuffle();
    });
    _speakText(currentTitle + ". " + currentStart);
  }

  void _toggleHint() {
    setState(() {
      showHint = !showHint;
    });
    if (showHint) {
      _speakText("ุชูููุญ: $currentHint");
    }
  }

  @override
  void dispose() {
    flutterTts.stop();
    super.dispose();
  }

  @override
  Widget build(BuildContext context) {
    if (showScore) {
      return Directionality(
        textDirection: TextDirection.rtl,
        child: Scaffold(
          backgroundColor: const Color(0xFFFFF6ED),
          body: Center(
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                const Text(
                  "๐ ุงููุชูุฌุฉ ุงูููุงุฆูุฉ ๐",
                  style: TextStyle(fontSize: 36, fontWeight: FontWeight.bold, color: Colors.orange),
                ),
                const SizedBox(height: 30),
                Text(
                  "ุงูุฅุฌุงุจุงุช ุงูุตุญูุญุฉ: $score ูู ${stories.length}",
                  style: const TextStyle(fontSize: 28, color: Colors.green),
                ),
                const SizedBox(height: 20),
                Text(
                  "ุงูุฏูุฉ: ${(score / stories.length * 100).toStringAsFixed(1)}%",
                  style: const TextStyle(fontSize: 24, color: Colors.blue),
                ),
                const SizedBox(height: 40),
                ElevatedButton.icon(
                  onPressed: _resetGame,
                  icon: const Icon(Icons.refresh, size: 30),
                  label: const Text("ุฅุนุงุฏุฉ ุงููุนุจุฉ", style: TextStyle(fontSize: 24)),
                  style: ElevatedButton.styleFrom(
                    backgroundColor: Colors.orange,
                    padding: const EdgeInsets.symmetric(horizontal: 30, vertical: 15),
                    shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
                  ),
                ),
              ],
            ),
          ),
        ),
      );
    }

    return Directionality(
      textDirection: TextDirection.rtl,
      child: Scaffold(
        backgroundColor: const Color(0xFFFFF6ED),
        appBar: AppBar(
          title: const Text("ุงุญูููู ูุฃูุง ุฃููู - ุงููุณุชูู ุงููุชูุฏู", 
            style: TextStyle(fontSize: 22, fontWeight: FontWeight.bold)),
          centerTitle: true,
          backgroundColor: const Color(0xFFFFA726),
          actions: [
            IconButton(
              icon: const Icon(Icons.help_outline, size: 30),
              onPressed: _toggleHint,
              tooltip: 'ุฅุธูุงุฑ ุงูุชูููุญ',
            ),
          ],
        ),
        body: Center(
          child: SingleChildScrollView(
            padding: const EdgeInsets.all(24),
            child: Column(
              mainAxisAlignment: MainAxisAlignment.center,
              children: [
                Text(
                  currentTitle,
                  style: const TextStyle(fontSize: 28, color: Colors.orange, fontWeight: FontWeight.bold),
                ),
                const SizedBox(height: 20),
                const Text(
                  "ุจุฏุงูุฉ ุงููุตุฉ:",
                  style: TextStyle(fontSize: 24, fontWeight: FontWeight.w500),
                ),
                const SizedBox(height: 12),
                Container(
                  padding: const EdgeInsets.all(16),
                  margin: const EdgeInsets.symmetric(vertical: 10),
                  decoration: BoxDecoration(
                    color: Colors.orange[50],
                    borderRadius: BorderRadius.circular(16),
                    border: Border.all(color: Colors.orange, width: 2),
                  ),
                  child: Text(
                    currentStart,
                    textAlign: TextAlign.center,
                    style: const TextStyle(fontSize: 22, color: Colors.brown),
                  ),
                ),
                const SizedBox(height: 20),
                if (showHint)
                  Container(
                    padding: const EdgeInsets.all(12),
                    margin: const EdgeInsets.symmetric(vertical: 10),
                    decoration: BoxDecoration(
                      color: Colors.blue[50],
                      borderRadius: BorderRadius.circular(12),
                      border: Border.all(color: Colors.blue),
                    ),
                    child: Text(
                      "๐ก ุชูููุญ: $currentHint",
                      style: const TextStyle(fontSize: 20, color: Colors.blue),
                      textAlign: TextAlign.center,
                    ),
                  ),
                const SizedBox(height: 20),
                const Text(
                  "ุงุฎุชุฑ ุงูููุงูุฉ ุงูููุงุณุจุฉ:",
                  style: TextStyle(fontSize: 24, fontWeight: FontWeight.w500),
                ),
                const SizedBox(height: 20),
                ...currentEndings.map((ending) => Padding(
                      padding: const EdgeInsets.symmetric(vertical: 10),
                      child: ElevatedButton(
                        onPressed: feedback == null ? () => _handleChoice(ending) : null,
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.white,
                          foregroundColor: Colors.black87,
                          side: BorderSide(
                            color: feedback != null && ending["isCorrect"] 
                              ? Colors.green 
                              : Colors.orange, 
                            width: 3),
                          padding: const EdgeInsets.symmetric(vertical: 16, horizontal: 20),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                          elevation: 4,
                        ),
                        child: Text(
                          ending["text"],
                          style: const TextStyle(fontSize: 20),
                          textAlign: TextAlign.center,
                        ),
                      ),
                    )),
                const SizedBox(height: 30),
                if (feedback != null)
                  Column(
                    children: [
                      Container(
                        padding: const EdgeInsets.all(16),
                        decoration: BoxDecoration(
                          color: feedback!.contains("โ") ? Colors.green[50] : Colors.red[50],
                          borderRadius: BorderRadius.circular(16),
                          border: Border.all(
                            color: feedback!.contains("โ") ? Colors.green : Colors.red, 
                            width: 2),
                        ),
                        child: Text(
                          feedback!,
                          style: TextStyle(
                            fontSize: 24,
                            color: feedback!.contains("โ") ? Colors.green : Colors.red,
                            fontWeight: FontWeight.bold,
                          ),
                          textAlign: TextAlign.center,
                        ),
                      ),
                      const SizedBox(height: 20),
                      ElevatedButton.icon(
                        onPressed: _nextStory,
                        icon: const Icon(Icons.arrow_forward, size: 30),
                        label: const Text("ุงูุชุงูู", style: TextStyle(fontSize: 24)),
                        style: ElevatedButton.styleFrom(
                          backgroundColor: Colors.green,
                          padding: const EdgeInsets.symmetric(horizontal: 40, vertical: 16),
                          shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(20)),
                        ),
                    ),  ],
                  ),
                const SizedBox(height: 20),
                Row(
                  mainAxisAlignment: MainAxisAlignment.center,
                  children: [
                    ElevatedButton.icon(
                      onPressed: () => _speakText(currentStart),
                      icon: const Icon(Icons.volume_up, size: 28),
                      label: const Text("ุณูุงุน ุงููุตุฉ", style: TextStyle(fontSize: 20)),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.orange,
                        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                      ),
                    ),
                    const SizedBox(width: 15),
                    ElevatedButton.icon(
                      onPressed: _toggleHint,
                      icon: Icon(showHint ? Icons.visibility_off : Icons.visibility, size: 28),
                      label: Text(showHint ? "ุฅุฎูุงุก ุงูุชูููุญ" : "ุชูููุญ", style: const TextStyle(fontSize: 20)),
                      style: ElevatedButton.styleFrom(
                        backgroundColor: Colors.blue,
                        padding: const EdgeInsets.symmetric(horizontal: 20, vertical: 12),
                        shape: RoundedRectangleBorder(borderRadius: BorderRadius.circular(16)),
                      ),
                 ), ],
                ),
                const SizedBox(height: 20),
                Text(
                  "ุงููุตุฉ ${currentStoryIndex + 1} ูู ${stories.length}",
                  style: const TextStyle(fontSize: 20, color: Colors.grey),
                ),
              ],
            ),
          ),
        ),
      ),
    );
  }
}